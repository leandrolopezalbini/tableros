<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableros Sec. Seg. Mercedes</title>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

  <style>
    /* ================== ESTILOS GLOBALES / BASE ================== */
    :root {
      --azul-principal: #0d47a1;
      --verde-principal: #4caf50;
      --texto: #212121;
      --fondo: #f5f5f5;
      --blanco: #FFFFFF;
      --color-nuevo: #4db6ac;
      --color-instalacion: #f44336;
      --color-energia: #ff9800;
      --color-conectividad: #66bb6a;
      --color-switch: #5e35b1;
      --color-informes: #26a69a;
      --color-mapa: var(--azul-principal);
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--fondo);
      color: var(--texto);
      padding: 20px;
      font-size: 16px;
    }

    h1 {
      text-align: center;
      color: var(--azul-principal);
      margin-bottom: 20px;
      font-size: 5rem;
    }

    /* Logo/Icono a la izquierda */
    .icono-izq {
      width: 10rem;
      height: 40px;
      margin-right: 15px;
      vertical-align: middle;
    }



    /* ================== TARJETAS DEL PANEL ================== */
    .cuadricula-panel {
      display: grid;
      gap: 25px;
      margin: 20px auto;
      max-width: 100%;
      grid-template-columns: repeat(2, 1fr);
    }

    .boton-tarjeta {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 10rem;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      color: var(--blanco);
      font-weight: bold;
      transition: 0.3s;
      padding: 5px;
      box-sizing: border-box;
      overflow: hidden;
    }

    .tarjeta-nuevo {
      background-color: var(--color-nuevo);
    }

    .tarjeta-instalacion {
      background-color: var(--color-instalacion);
    }

    .tarjeta-energia {
      background-color: var(--color-energia);
    }

    .tarjeta-conectividad {
      background-color: var(--color-conectividad);
    }

    .tarjeta-informes {
      background-color: var(--color-informes);
    }

    .tarjeta-mapa {
      background-color: var(--color-mapa);
    }

    .tarjeta-switch {
      background-color: var(--color-switch);
    }

    /* Estilo para el texto dentro del bot贸n */
    .boton-tarjeta span {
      width: 100%;
      display: block;
      text-align: center;
      font-size: 1.75rem;
      line-height: 1.2;
      white-space: normal;
    }

    .boton-tarjeta:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      /* Usamos un color de hover gen茅rico m谩s oscuro */
      filter: brightness(1.1);
    }

    .boton-tarjeta .material-icons {
      font-size: 3.5rem;
      margin-bottom: 5px;
    }

    /* ================== CONTENEDORES DE PGINAS ================== */
    .page-content {
      display: none;
      max-width: 95%;
      margin: 0 auto;
    }

    .active-page {
      display: block;
    }

    .contenedor-formulario {
      background-color: var(--blanco);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    /* Toast personalizado */
    .toast-custom {
      position: fixed !important;
      top: 10px !important;
      right: 10px !important;
      opacity: 0.9 !important;
      font-size: 1em !important;
      z-index: 1000 !important;
    }

    @media (max-width: 600px) {
      .toast-custom {
        top: 20px !important;
        left: 10px !important;
        right: 10px !important;
        font-size: 1.2em !important;
        text-align: center !important;
      }

      /* Ajustes para radio buttons en m贸viles */
      .input-field div[style*="display: flex"] {
        flex-direction: column !important;
        gap: 10px !important;
      }
    }

    /* ================== SISTEMA DE REJILLA SIMPLE (REEMPLAZANDO COL) ================== */
    /* Aplicado solo a la secci贸n de Latitud/Longitud para demostrar CSS puro */
    .grid-campos-dobles {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .grid-campos-dobles>.input-field {
      flex: 1 1 50%;
      /* Ocupa la mitad del espacio */
      margin-bottom: 0;
      font-size: 1.5rem;
    }

    /* Media Query para pantallas peque帽as, asegurando la responsividad */
    @media (max-width: 600px) {
      .grid-campos-dobles {
        flex-direction: column;
        gap: 0;
      }
    }

    .h1 {
      text-align: center;
      color: var(--azul-principal);
      margin-bottom: 10px;
      font-size: 3.5rem;
    }

    .btn-volver {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--verde-principal);
      color: var(--blanco);
      font-weight: bold;
      padding: 7px 10px;
      border-radius: 30px;
      cursor: pointer;
      margin: 10px;
      transition: all 0.3s ease;
    }

    .btn-volver:hover {
      background: #66bb6a;
      transform: translateY(-2px);
    }

    .btn {
      font-size: 1.25rem;
    }

    #tablaResultadosInforme table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    #tablaResultadosInforme th,
    #tablaResultadosInforme td {
      padding: 8px;
      text-align: left;
      font-size: 0.9rem;
    }

    .resultado-item {
      background-color: var(--blanco);
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .resultado-item p {
      margin: 5px 0;
      font-size: 1rem;
    }

    .resultado-item strong {
      color: var(--azul-principal);
    }

    /* Clases de estado (para Materialize en el HTML) */
    .amber.lighten-4 {
      background-color: #ffecb3 !important;
    }

    .red.lighten-4 {
      background-color: #ffcdd2 !important;
    }

    .green.lighten-4 {
      background-color: #c8e6c9 !important;
    }

    .deep-orange.lighten-4 {
      background-color: #ffccbc !important;
    }
  </style>
</head>

<body>
  <div id="panel-page" class="page-content active-page">
    <div><img src="https://nw.mercedes.gob.ar/img/logo.svg" alt="icono" class="icono-izq"></div>
    <h1>Gesti贸n de Tableros</h1>
    <div class="cuadricula-panel">
      <div class="boton-tarjeta tarjeta-nuevo" data-page="nuevo">
        <i class="material-icons">add_box</i><span>Nuevo Tablero</span>
      </div>

      <div class="boton-tarjeta tarjeta-instalacion" data-page="instalacion">
        <i class="material-icons">arrow_downward</i><span>Registrar Instalaci贸n</span>
      </div>

      <div class="boton-tarjeta tarjeta-energia" data-page="energia">
        <i class="material-icons">bolt</i><span>Registrar Energ铆a</span>
      </div>

      <div class="boton-tarjeta tarjeta-conectividad" data-page="conectividad">
        <i class="material-icons">router</i><span>Registrar Conectividad</span>
      </div>

      <div class="boton-tarjeta tarjeta-switch" data-page="switch">
        <i class="material-icons">settings_ethernet</i><span>Agregar Switch</span>
      </div>

      <div class="boton-tarjeta tarjeta-informes" data-page="informes">
        <i class="material-icons">article</i><span>Informes</span>
      </div>

      <div class="boton-tarjeta tarjeta-mapa" id="btnMapa" data-page="mapa">
        <i class="material-icons">add_location</i><span>Ver Mapa</span>
      </div>
    </div>
  </div>

  <div id="nuevo-page" class="page-content">
    <div><img src="https://nw.mercedes.gob.ar/img/logo.svg" alt="icono" class="icono-izq"></div>
    <div class="btn-volver" data-page="panel"><i class="material-icons">arrow_back</i> Volver al Panel</div>
    <div class="contenedor-formulario">
      <h2>Pedido de Nuevo Tablero</h2>
      <form id="form-nuevo-tablero">
        <div class="input-field">
          <input type="text" id="direccion" required>
          <label for="direccion">Direcci贸n/Ubicaci贸n</label>
        </div>

        <div class="input-field">
          <p style="margin-bottom: 10px;">驴Est谩 marcado en el lugar?</p>
          <div style="display: flex; flex-wrap: wrap; gap: 20px;">
            <label>
              <input type="radio" name="marcado" value="SI" required>
              <span>S</span>
            </label>
            <label>
              <input type="radio" name="marcado" value="NO" required>
              <span>NO (Detallar en Observaciones)</span>
            </label>
          </div>
        </div>

        <div class="input-field">
          <textarea id="observaciones" class="materialize-textarea"></textarea>
          <label for="observaciones">Observaciones</label>
        </div>

        <div class="grid-campos-dobles">
          <div class="input-field">
            <input type="text" id="nuevoLatitud" placeholder="Latitud">
            <label for="nuevoLatitud">Latitud (opcional)</label>
          </div>
          <div class="input-field">
            <input type="text" id="nuevoLongitud" placeholder="Longitud">
            <label for="nuevoLongitud">Longitud (opcional)</label>
          </div>
        </div>
        <div class="row">
          <div class="col s12">
            <button type="button" id="btnObtenerUbicacionNuevo" class="btn waves-effect waves-light blue darken-1">
              <i class="material-icons left">location_on</i> Obtener Coordenadas
            </button>
            <span id="ubicacionStatusNuevo" style="margin-left: 10px; font-style: italic;"></span>
          </div>
        </div>

        <button type="submit" class="btn waves-effect waves-light" style="background-color: var(--color-nuevo);">
          Crear Tablero (Estado: PEDIDO)
        </button>
      </form>
    </div>
  </div>

  <div id="instalacion-page" class="page-content">
    <div><img src="https://nw.mercedes.gob.ar/img/logo.svg" alt="icono" class="icono-izq"></div>
    <div class="btn-volver" data-page="panel"><i class="material-icons">arrow_back</i> Volver al Panel</div>
    <div class="contenedor-formulario">
      <h2>Registrar Instalaci贸n</h2>
      <form id="form-instalacion">
        <div class="input-field">
          <input type="text" id="autocompleteInstalacion" class="autocomplete" required>
          <label for="autocompleteInstalacion">Buscar Tablero (Estado: PEDIDO)</label>
        </div>
        <input type="hidden" id="tableroInstalacionId">

        <div class="grid-campos-dobles">
          <div class="input-field">
            <input type="text" id="instalacionLatitud" placeholder="Latitud" value="">
            <label for="instalacionLatitud">Latitud </label>
          </div>
          <div class="input-field">
            <input type="text" id="instalacionLongitud" placeholder="Longitud" value="">
            <label for="instalacionLongitud">Longitud </label>
          </div>
        </div>
        <div class="row">
          <div class="col s12">
            <button type="button" id="btnObtenerUbicacion" class="btn waves-effect waves-light blue darken-1">
              <i class="material-icons left">location_on</i> Obtener Coordenadas
            </button>
            <span id="ubicacionStatus" style="margin-left: 10px; font-style: italic;"></span>
          </div>
        </div>

        <div class="input-field">
          <textarea id="obsInstalacion" class="materialize-textarea"></textarea>
          <label for="obsInstalacion">Observaciones de la Instalaci贸n</label>
        </div>

        <button type="submit" class="btn waves-effect waves-light red darken-2">Registrar (Cambiar a
          INSTALADO)</button>
      </form>
    </div>
  </div>

  <div id="energia-page" class="page-content">
    <div><img src="https://nw.mercedes.gob.ar/img/logo.svg" alt="icono" class="icono-izq"></div>
    <div class="btn-volver" data-page="panel"><i class="material-icons">arrow_back</i> Volver al Panel</div>
    <div class="contenedor-formulario">
      <h2>Registrar Energ铆a</h2>
      <form id="form-energia">
        <div class="input-field">
          <input type="text" id="autocompleteEnergia" class="autocomplete" required>
          <label for="autocompleteEnergia">Buscar Tablero (Instalado/Energ铆a Pendiente)</label>
        </div>
        <input type="hidden" id="tableroEnergiaId">

        <div class="input-field">
          <p>Proveedor de Energ铆a</p>
          <div style="display: flex; flex-wrap: wrap; gap: 15px;">
            <label><input type="radio" name="proveedorEnergia" value="EDEN" required> <span>EDEN</span></label>
            <label><input type="radio" name="proveedorEnergia" value="OTRA" required> <span>OTRA</span></label>
          </div>
        </div>
        <div class="input-field detalle-proveedor-energia" style="display: none;">
          <input type="text" id="detalleProveedorEnergia">
          <label for="detalleProveedorEnergia">Detalle del Proveedor (si es 'Otra')</label>
        </div>

        <div class="input-field">
          <textarea id="obsEnergia" class="materialize-textarea"></textarea>
          <label for="obsEnergia">Observaciones</label>
        </div>
        <button type="submit" class="btn waves-effect waves-light orange darken-2">
          Registrar (Cambiar Energ铆a a CONECTADA)
        </button>
      </form>
    </div>
  </div>

  <div id="conectividad-page" class="page-content">
    <div><img src="https://nw.mercedes.gob.ar/img/logo.svg" alt="icono" class="icono-izq"></div>
    <div class="btn-volver" data-page="panel"><i class="material-icons">arrow_back</i> Volver al Panel</div>
    <div class="contenedor-formulario">
      <h2>Registrar Conectividad</h2>
      <form id="form-conectividad">
        <div class="input-field">
          <input type="text" id="autocompleteConectividad" class="autocomplete" required>
          <label for="autocompleteConectividad">Buscar Tablero (Instalado/Conectividad Pendiente)</label>
        </div>
        <input type="hidden" id="tableroConectividadId">

        <!-- b煤squeda por nombre de switch -->
        <div class="input-field">
          <input type="text" id="filtroSwitch" placeholder="Ej.: SW-A-001">
          <label for="filtroSwitch">Filtrar por Nombre de Switch</label>
        </div>

        <div class="input-field">
          <p>Tipo de Conectividad</p>
          <div style="display: flex; flex-wrap: wrap; gap: 15px;">
            <label><input type="radio" name="tipoConectividad" value="FIBRA OPTICA" required> <span>FIBRA OPTICA</span></label>
            <label><input type="radio" name="tipoConectividad" value="AIRE" required> <span>AIRE</span></label>
            <label><input type="radio" name="tipoConectividad" value="CASCADA" required> <span>CASCADA</span></label>
            <label><input type="radio" name="tipoConectividad" value="OTRO" required> <span>OTRO</span></label>
          </div>
        </div>

        <div class="input-field">
          <p>Proveedor de Servicio</p>
          <div style="display: flex; flex-wrap: wrap; gap: 15px;">
            <label><input type="radio" name="proveedorConectividad" value="INTERFAS" required> <span>INTERFAS</span></label>
            <label><input type="radio" name="proveedorConectividad" value="IPNEXT" required> <span>IPNEXT</span></label>
            <label><input type="radio" name="proveedorConectividad" value="MUNICIPALIDAD" required> <span>MUNICIPALIDAD</span></label>
            <label><input type="radio" name="proveedorConectividad" value="COM" required> <span>COM</span></label>
            <label><input type="radio" name="proveedorConectividad" value="OTRA" required> <span>OTRA</span></label>
          </div>
        </div>

        <div class="input-field detalle-proveedor-conectividad" style="display: none;">
          <input type="text" id="detalleProveedorConectividad">
          <label for="detalleProveedorConectividad">Detalle del Proveedor (si es 'Otra')</label>
        </div>

        <div class="input-field">
          <textarea id="obsConectividad" class="materialize-textarea"></textarea>
          <label for="obsConectividad">Observaciones</label>
        </div>

        <button type="submit" class="btn tarjeta-conectividad">
          Registrar (Cambiar a CONECTADA)
        </button>
      </form>
    </div>
  </div>

  <div id="switch-page" class="page-content">
    <div><img src="https://nw.mercedes.gob.ar/img/logo.svg" alt="icono" class="icono-izq"></div>
    <div class="btn-volver" data-page="panel"><i class="material-icons">arrow_back</i> Volver al Panel</div>
    <div class="contenedor-formulario">
      <h2>Agregar Switch</h2>
      <form id="form-switch">
        <div class="input-field">
          <input type="text" id="autocompleteSwitch" class="autocomplete" required>
          <label for="autocompleteSwitch">Buscar Tablero (Instalado)</label>
        </div>
        <input type="hidden" id="tableroSwitchId">

        <div class="input-field">
          <input type="text" id="inputSwitch" placeholder="Ej.: SW-A-001" required>
          <label for="inputSwitch">Nombre del Switch</label>
        </div>

        <div class="input-field">
          <textarea id="obsSwitch" class="materialize-textarea"></textarea>
          <label for="obsSwitch">Observaciones</label>
        </div>

        <button type="submit" class="btn waves-effect waves-light green darken-2">
          Guardar Switch
        </button>
      </form>
    </div>
  </div>


  <div id="informes-page" class="page-content">
    <div><img src="https://nw.mercedes.gob.ar/img/logo.svg" alt="icono" class="icono-izq"></div>
    <div class="btn-volver" data-page="panel"><i class="material-icons">arrow_back</i> Volver al Panel</div>
    <div class="contenedor-formulario">
      <h2> Generaci贸n de Informes y Estado</h2>
      <form id="form-filtros">
        <div class="row">
          <div class="input-field col s12 m6">
            <p>Filtrar por Estado</p>
            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
              <label><input type="radio" name="filtroEstado" value="" checked> <span>Cualquier Estado</span></label>
              <label><input type="radio" name="filtroEstado" value="PEDIDO"> <span>PEDIDO</span></label>
              <label><input type="radio" name="filtroEstado" value="INSTALADO"> <span>INSTALADO</span></label>
            </div>
          </div>
          <div class="input-field col s12 m6">
            <p>Filtrar por Energ铆a</p>
            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
              <label><input type="radio" name="filtroEnergia" value="" checked> <span>Cualquier Energ铆a</span></label>
              <label><input type="radio" name="filtroEnergia" value="PENDIENTE"> <span>PENDIENTE</span></label>
              <label><input type="radio" name="filtroEnergia" value="CONECTADA"> <span>CONECTADA</span></label>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12 m6">
            <p>Filtrar por Conectividad</p>
            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
              <label><input type="radio" name="filtroConectividad" value="" checked> <span>Cualquier Conectividad</span></label>
              <label><input type="radio" name="filtroConectividad" value="PENDIENTE"> <span>PENDIENTE</span></label>
              <label><input type="radio" name="filtroConectividad" value="CONECTADA"> <span>CONECTADA</span></label>
            </div>
          </div>
          <div class="input-field col s12 m6">
            <input type="text" id="filtroDireccion" placeholder="Escriba parte de la direcci贸n">
            <label for="filtroDireccion">Filtrar por Direcci贸n (contiene)</label>
          </div>
        </div>

        <div class="row">
          <div class="col s12 m6 l4">
            <button type="submit" class="btn waves-effect waves-light blue darken-1" style="width: 100%;">
              <i class="material-icons left">search</i> Vista Previa
            </button>
          </div>
          <div class="col s12 m6 l8 right-align">
            <span id="conteoResultados" style="margin-right: 15px; font-weight: bold; font-size: 1.1em;">
              Resultados: <span id="countDescarga" class="blue-text darken-2">0</span>
            </span>
            <button id="btnDescargarInforme" type="button" class="btn waves-effect waves-light red darken-4" disabled>
              <i class="material-icons left">picture_as_pdf</i> Descargar Informe PDF
            </button>
          </div>
        </div>
      </form>

      <div class="divider" style="margin: 20px 0;"></div>

      <h3>Resultados de la B煤squeda</h3>
      <div class="responsive-table" id="tablaResultadosInforme">
        <p class="center-align grey-text">Presione "Vista Previa" para mostrar los resultados.</p>
      </div>
    </div>
  </div>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Inicializaci贸n de Materialize
      M.AutoInit();
      M.updateTextFields();

      const SCRIPT_RUN = google.script.run.withFailureHandler(err => {
        M.toast({ html: 'Error del servidor: ' + err.message, classes: 'red darken-3' });
        console.error(err);
        document.querySelectorAll('button').forEach(btn => btn.disabled = false);
      });

      // --- Utilidades ---
      function ocultarTodas() {
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active-page'));
      }

      // --- Autocomplete ---
      window.initAutocomplete = function (inputId, hiddenId, serverFunc, fetchDetails = false) {
        const elem = document.getElementById(inputId);
        if (!elem) return;
        const instance = M.Autocomplete.getInstance(elem);
        if (instance) instance.destroy();

        google.script.run
          .withFailureHandler(err => {
            console.error("Error en " + serverFunc + ": ", err);
            M.toast({ html: 'Error cargando datos de ' + serverFunc, classes: 'red' });
          })
          .withSuccessHandler(data => {
            if (!Array.isArray(data)) return;
            const opciones = {};
            const detalles = {};
            data.forEach(o => {
              const key = `${o.direccion} (${o.id})`;
              opciones[key] = null;
              if (fetchDetails) detalles[o.id] = o;
            });
            M.Autocomplete.init(elem, {
              data: opciones,
              limit: 10,
              minLength: 1,
              onAutocomplete: val => {
                const match = val.match(/\(([^)]+)\)$/);
                const selectedId = match ? match[1] : '';
                const hiddenElem = document.getElementById(hiddenId);
                if (hiddenElem) hiddenElem.value = selectedId;
                if (fetchDetails && selectedId && detalles[selectedId]) {
                  const tablero = detalles[selectedId];
                  if (inputId === 'autocompleteConectividad') {
                    const tipoRadio = document.querySelector('input[name="tipoConectividad"][value="' + (tablero.tipoConectividad || '').toUpperCase() + '"]');
                    if (tipoRadio) tipoRadio.checked = true;
                    const provRadios = document.querySelectorAll('input[name="proveedorConectividad"]');
                    const inputDetalle = document.getElementById('detalleProveedorConectividad');
                    const divDetalle = document.querySelector('.detalle-proveedor-conectividad');
                    const provPlanilla = (tablero.proveedorConectividad || '').toUpperCase();
                    const radioOtra = document.querySelector('input[name="proveedorConectividad"][value="OTRA"]');
                    if (provRadios) {
                      provRadios.forEach(r => r.checked = false);
                      const matchingRadio = Array.from(provRadios).find(r => r.value === provPlanilla);
                      if (matchingRadio) {
                        matchingRadio.checked = true;
                        if (divDetalle) divDetalle.style.display = 'none';
                      } else if (provPlanilla !== "") {
                        if (radioOtra) radioOtra.checked = true;
                        if (inputDetalle) inputDetalle.value = provPlanilla;
                        if (divDetalle) divDetalle.style.display = 'block';
                      }
                    }
                    M.updateTextFields();
                    M.toast({ html: 'Datos cargados', classes: 'blue' });
                  }
                }
              }
            });
          })[serverFunc]();
      };

      // --- Cambio de proveedor ---
      function handleProveedorChange(radioName, detailSelector) {
        const radios = document.querySelectorAll('input[name="' + radioName + '"]');
        radios.forEach(radio => {
          radio.addEventListener('change', function () {
            const detailDiv = document.querySelector(detailSelector);
            const detailInput = detailDiv.querySelector('input');
            if (this.value === 'OTRA') {
              detailDiv.style.display = 'block';
              if (detailInput) detailInput.setAttribute('required', 'true');
            } else {
              detailDiv.style.display = 'none';
              if (detailInput) {
                detailInput.value = '';
                detailInput.removeAttribute('required');
              }
            }
            M.updateTextFields();
          });
        });
      }

      // --- Geolocalizaci贸n ---
      function obtenerUbicacion() {
        const latInput = document.getElementById('instalacionLatitud');
        const lngInput = document.getElementById('instalacionLongitud');
        const statusSpan = document.getElementById('ubicacionStatus');
        if (!latInput || !lngInput || !statusSpan) return;
        latInput.value = ''; lngInput.value = ''; M.updateTextFields();
        statusSpan.textContent = 'Buscando ubicaci贸n...';
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude.toFixed(5);
              const lng = position.coords.longitude.toFixed(5);
              latInput.value = lat; lngInput.value = lng;
              M.updateTextFields();
              statusSpan.textContent = 'Ubicaci贸n obtenida.';
              M.toast({ html: 'Ubicaci贸n obtenida.', classes: 'blue toast-custom' });
            },
            (error) => {
              let msg = 'Error de ubicaci贸n: ';
              switch (error.code) {
                case error.PERMISSION_DENIED: msg += "Usuario deneg贸 la solicitud."; break;
                case error.POSITION_UNAVAILABLE: msg += "Informaci贸n de ubicaci贸n no disponible."; break;
                case error.TIMEOUT:
                  msg += "Tiempo de espera agotado. Ingrese coordenadas manualmente.";
                  statusSpan.textContent = 'Ingrese coordenadas manualmente en los campos.';
                  break;
                default: msg += "Error desconocido."; break;
              }
              console.error("Error Geolocation:", msg, error);
              statusSpan.textContent = 'Error al obtener ubicaci贸n.';
              M.toast({ html: msg, classes: 'red darken-3' });
            }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
          );
        } else {
          statusSpan.textContent = 'Geolocalizaci贸n no soportada.';
          M.toast({ html: 'Geolocalizaci贸n no disponible.', classes: 'red darken-3' });
        }
      }

      window.showPage = function (pageId) {
        ocultarTodas();
        const page = document.getElementById(pageId + '-page');
        if (page) page.classList.add('active-page');

        if (pageId !== 'panel' && window._lastPage !== pageId) {
          if (SCRIPT_RUN.registrarAccesoUsuario) {
            SCRIPT_RUN.registrarAccesoUsuario('P谩gina: ' + pageId.toUpperCase());
          }
          window._lastPage = pageId;
        }

        if (pageId === 'nuevo') {
          const formNuevo = document.getElementById('form-nuevo-tablero');
          if (formNuevo && !formNuevo._listenerAdded) {
            formNuevo.addEventListener('submit', e => {
              e.preventDefault();
              const btn = e.submitter; btn.disabled = true;
              const data = {
                direccion: document.getElementById('direccion').value,
                marcado: document.querySelector('input[name="marcado"]:checked').value,
                observaciones: document.getElementById('observaciones').value,
                latitud: document.getElementById('nuevoLatitud').value || 'PENDIENTE',
                longitud: document.getElementById('nuevoLongitud').value || 'PENDIENTE'
              };
              SCRIPT_RUN.withSuccessHandler(res => {
                M.toast({ html: res.success ? `Tablero ${res.id} creado.` : `Error: ${res.message}`, classes: res.success ? 'green darken-1 toast-custom' : 'red darken-3 toast-custom' });
                formNuevo.reset(); M.updateTextFields(); btn.disabled = false;
              }).crearNuevoTablero(data);
            });
            formNuevo._listenerAdded = true;
          }
          document.getElementById('nuevoLatitud').value = '';
          document.getElementById('nuevoLongitud').value = '';
          const statusSpanNuevo = document.getElementById('ubicacionStatusNuevo'); if (statusSpanNuevo) statusSpanNuevo.textContent = '';
          M.updateTextFields();
          const btnUbicacionNuevo = document.getElementById('btnObtenerUbicacionNuevo');
          if (btnUbicacionNuevo && !btnUbicacionNuevo._listenerAdded) {
            const handler = () => {
              const latInput = document.getElementById('nuevoLatitud');
              const lngInput = document.getElementById('nuevoLongitud');
              const statusSpan = document.getElementById('ubicacionStatusNuevo');
              if (!latInput || !lngInput || !statusSpan) return;
              latInput.value = ''; lngInput.value = ''; M.updateTextFields();
              statusSpan.textContent = 'Buscando ubicaci贸n...';
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                  (position) => {
                    const lat = position.coords.latitude.toFixed(5);
                    const lng = position.coords.longitude.toFixed(5);
                    latInput.value = lat; lngInput.value = lng;
                    M.updateTextFields();
                    statusSpan.textContent = 'Ubicaci贸n obtenida.';
                    M.toast({ html: 'Ubicaci贸n obtenida.', classes: 'blue toast-custom' });
                  },
                  (error) => {
                    let msg = 'Error de ubicaci贸n: ';
                    switch (error.code) {
                      case error.PERMISSION_DENIED: msg += "Usuario deneg贸 la solicitud."; break;
                      case error.POSITION_UNAVAILABLE: msg += "Informaci贸n de ubicaci贸n no disponible."; break;
                      case error.TIMEOUT:
                        msg += "Tiempo de espera agotado. Ingrese coordenadas manualmente.";
                        statusSpan.textContent = 'Ingrese coordenadas manualmente en los campos.';
                        break;
                      default: msg += "Error desconocido."; break;
                    }
                    console.error("Error Geolocation:", msg, error);
                    statusSpan.textContent = 'Error al obtener ubicaci贸n.';
                    M.toast({ html: msg, classes: 'red darken-3' });
                  }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
              } else {
                statusSpan.textContent = 'Geolocalizaci贸n no soportada.';
                M.toast({ html: 'Geolocalizaci贸n no disponible.', classes: 'red darken-3' });
              }
            };
            btnUbicacionNuevo.addEventListener('click', handler);
            btnUbicacionNuevo.addEventListener('touchstart', handler);
            btnUbicacionNuevo._listenerAdded = true;
          }
        }

        // INSTALACIN
        if (pageId === 'instalacion') {
          initAutocomplete('autocompleteInstalacion', 'tableroInstalacionId', 'listarTablerosPedido');
          document.getElementById('instalacionLatitud').value = '';
          document.getElementById('instalacionLongitud').value = '';
          const statusSpan = document.getElementById('ubicacionStatus'); if (statusSpan) statusSpan.textContent = '';
          M.updateTextFields();
          const btnUbicacion = document.getElementById('btnObtenerUbicacion');
          if (btnUbicacion && !btnUbicacion._listenerAdded) {
            const handler = obtenerUbicacion;
            btnUbicacion.addEventListener('click', handler);
            btnUbicacion.addEventListener('touchstart', handler);
            btnUbicacion._listenerAdded = true;
          }
          const formInstalacion = document.getElementById('form-instalacion');
          if (formInstalacion && !formInstalacion._listenerAdded) {
            formInstalacion.addEventListener('submit', e => {
              e.preventDefault();
              const btn = e.submitter; if (btn) btn.disabled = true;

              const id = document.getElementById('tableroInstalacionId')?.value || '';
              const latitud = document.getElementById('instalacionLatitud')?.value || '';
              const longitud = document.getElementById('instalacionLongitud')?.value || '';

              if (!id) {
                M.toast({ html: 'Debe seleccionar un Tablero.' });
                if (btn) btn.disabled = false;
                return;
              }

              if (!latitud || !longitud) {
                M.toast({
                  html: 'Advertencia: Coordenadas vac铆as. Presione "Obtener Coordenadas" o ingrese manualmente.',
                  classes: 'orange darken-3 toast-custom'
                });
              }

              const data = {
                id, latitud, longitud,
                observaciones: document.getElementById('obsInstalacion')?.value || ''
              };

              SCRIPT_RUN.withSuccessHandler(res => {
                M.toast({
                  html: res.success ? `Tablero ${id} instalado con 茅xito.` : `Error: ${res.message}`,
                  classes: res.success ? 'green darken-1 toast-custom' : 'red darken-3 toast-custom'
                });
                formInstalacion.reset();
                M.updateTextFields();
                if (btn) btn.disabled = false;
                showPage('panel');
              }).registrarInstalacionTablero(data);
            });
            formInstalacion._listenerAdded = true;
          }
        }

        // ENERGA
        if (pageId === 'energia') {
          initAutocomplete('autocompleteEnergia', 'tableroEnergiaId', 'listarTablerosParaEnergia');
          handleProveedorChange('proveedorEnergia', '.detalle-proveedor-energia');
          const formEnergia = document.getElementById('form-energia');
          if (formEnergia && !formEnergia._listenerAdded) {
            formEnergia.addEventListener('submit', e => {
              e.preventDefault();
              const btn = e.submitter; if (btn) btn.disabled = true;
              const id = document.getElementById('tableroEnergiaId')?.value || '';
              const proveedor = document.querySelector('input[name="proveedorEnergia"]:checked')?.value || '';
              const detalleProveedor = document.getElementById('detalleProveedorEnergia')?.value || '';
              const data = {
                id,
                proveedor,
                detalleProveedor: proveedor === 'OTRA' ? detalleProveedor : proveedor,
                observaciones: document.getElementById('obsEnergia')?.value || ''
              };
              if (!id) { M.toast({ html: 'Debe seleccionar un Tablero.' }); if (btn) btn.disabled = false; return; }
              SCRIPT_RUN.withSuccessHandler(res => {
                M.toast({ html: res.success ? `Energ铆a de ${id} CONECTADA.` : `Error: ${res.message}`, classes: res.success ? 'green darken-1 toast-custom' : 'red darken-3 toast-custom' });
                formEnergia.reset(); M.updateTextFields(); if (btn) btn.disabled = false; showPage('panel');
              }).registrarEnergiaTablero(data);
            });
            formEnergia._listenerAdded = true;
          }
        }

        // CONECTIVIDAD
        if (pageId === 'conectividad') {
          initAutocomplete('autocompleteConectividad', 'tableroConectividadId', 'listarTablerosParaConectividad', true);
          handleProveedorChange('proveedorConectividad', '.detalle-proveedor-conectividad');
          const formCon = document.getElementById('form-conectividad');
          if (formCon && !formCon._listenerAdded) {
            formCon.addEventListener('submit', e => {
              e.preventDefault();
              const btn = e.submitter; if (btn) btn.disabled = true;
              const id = document.getElementById('tableroConectividadId')?.value || '';
              const proveedor = document.querySelector('input[name="proveedorConectividad"]:checked')?.value || '';
              const detalleProveedor = document.getElementById('detalleProveedorConectividad')?.value || '';
              const tipo = document.querySelector('input[name="tipoConectividad"]:checked')?.value || '';
              const switchName = document.getElementById('filtroSwitch')?.value || '';

              const data = {
                id,
                proveedor,
                detalleProveedor: proveedor === 'OTRA' ? detalleProveedor : proveedor,
                tipo,
                switch: switchName,
                observaciones: document.getElementById('obsConectividad')?.value || ''
              };

              if (!id) { M.toast({ html: 'Debe seleccionar un Tablero.' }); if (btn) btn.disabled = false; return; }

              SCRIPT_RUN.withSuccessHandler(res => {
                M.toast({ html: res.success ? `Conectividad de ${id} CONECTADA.` : `Error: ${res.message}`, classes: res.success ? 'green darken-1 toast-custom' : 'red darken-3 toast-custom' });
                formCon.reset(); M.updateTextFields(); if (btn) btn.disabled = false; showPage('panel');
              }).registrarConectividadTablero(data);
            });
            formCon._listenerAdded = true;
          }
        }

        // SWITCH
        if (pageId === 'switch') {
          initAutocomplete('autocompleteSwitch', 'tableroSwitchId', 'listarTablerosParaSwitch', false);
          const formSwitch = document.getElementById('form-switch');
          if (formSwitch && !formSwitch._listenerAdded) {
            formSwitch.addEventListener('submit', e => {
              e.preventDefault();
              const btn = e.submitter; if (btn) btn.disabled = true;
              const id = document.getElementById('tableroSwitchId')?.value || '';
              const switchName = document.getElementById('inputSwitch')?.value || '';
              const data = {
                id,
                switch: switchName,
                observaciones: document.getElementById('obsSwitch')?.value || ''
              };
              if (!id) { M.toast({ html: 'Debe seleccionar un Tablero.' }); if (btn) btn.disabled = false; return; }
              SCRIPT_RUN.withSuccessHandler(res => {
                M.toast({ html: res.success ? `Switch ${switchName} vinculado.` : `Error: ${res.message}`, classes: res.success ? 'green darken-1 toast-custom' : 'red darken-3 toast-custom' });
                formSwitch.reset(); M.updateTextFields(); if (btn) btn.disabled = false; showPage('panel');
              }).vincularSwitchTablero(data);
            });
            formSwitch._listenerAdded = true;
          }
        }

        // INFORMES
        if (pageId === 'informes') {
          const formFiltros = document.getElementById('form-filtros');
          if (formFiltros && !formFiltros._listenerAdded) {
            formFiltros.addEventListener('submit', e => {
              e.preventDefault();
              const filtros = {
                estado: document.querySelector('input[name="filtroEstado"]:checked').value || '',
                energia: document.querySelector('input[name="filtroEnergia"]:checked').value || '',
                conectividad: document.querySelector('input[name="filtroConectividad"]:checked').value || '',
                direccionContains: document.getElementById('filtroDireccion').value || ''
              }; //  cierre correcto del objeto

              SCRIPT_RUN.withSuccessHandler(generarTablaVistaPrevia).listarTablerosFiltrados(filtros);
            });
            formFiltros._listenerAdded = true;
          }

          const btnDescargar = document.getElementById('btnDescargarInforme');
          if (btnDescargar && !btnDescargar._listenerAdded) {
            const handler = () => {
              btnDescargar.disabled = true;
              const filtrosActuales = {
                estado: document.querySelector('input[name="filtroEstado"]:checked').value || '',
                energia: document.querySelector('input[name="filtroEnergia"]:checked').value || '',
                conectividad: document.querySelector('input[name="filtroConectividad"]:checked').value || '',
                direccionContains: document.getElementById('filtroDireccion').value || '',
                switchContains: document.getElementById('filtroSwitch').value || ''
              };
              SCRIPT_RUN.withSuccessHandler(base64 => {
                try {
                  const dataUrl = 'data:application/pdf;base64,' + base64;
                  const a = document.createElement('a');
                  const ts = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                  a.href = dataUrl;
                  a.download = `Informe_Tableros_${ts}.pdf`;
                  document.body.appendChild(a);
                  a.click();
                  a.remove();
                  M.toast({ html: 'Informe descargado correctamente.', classes: 'green darken-1 toast-custom' });
                } catch (err) {
                  console.error(err);
                  M.toast({ html: 'Error generando descarga.', classes: 'red darken-3 toast-custom' });
                } finally {
                  btnDescargar.disabled = false;
                }
              }).generarInformePDF(filtrosActuales);
            };
            btnDescargar.addEventListener('click', handler);
            btnDescargar.addEventListener('touchstart', handler);
            btnDescargar._listenerAdded = true;
          }
        }



          // Limpia informe cuando sal铆s de esa secci贸n
          if (pageId !== 'informes') {
            const cont = document.getElementById('tablaResultadosInforme');
            if (cont) cont.innerHTML = '<p class="center-align grey-text">Presione "Vista Previa" para mostrar los resultados.</p>';
            const btnDesc = document.getElementById('btnDescargarInforme');
            if (btnDesc) btnDesc.disabled = true;
            const countEl = document.getElementById('countDescarga');
            if (countEl) countEl.textContent = 0;
          }

          // Re-inicializar selects
          document.querySelectorAll('select').forEach(el => {
            const instance = M.FormSelect.getInstance(el);
            if (instance) instance.destroy();
            M.FormSelect.init(el);
          });
        } //  este es el cierre correcto de window.showPage


        // --- Funci贸n abrir mapa ---
        function abrirMapa() {
          const mapUrl = "https://www.google.com/maps/d/edit?mid=16ZDkCjQQJKOO9w6t7rGCaQ9ibLUH8ps&ll=-34.626221418673786%2C-59.42575859457151&z=17";
          window.open(mapUrl, '_blank');
          M.toast({ html: 'Abriendo Mapa en una nueva pesta帽a...', classes: 'blue' });
          if (SCRIPT_RUN.registrarAccesoUsuario) {
            SCRIPT_RUN.registrarAccesoUsuario('P谩gina: MAPA');
          }
        }

        // --- Navegaci贸n: tarjetas y botones Volver ---
        document.querySelectorAll('.boton-tarjeta[data-page], .btn-volver[data-page]').forEach(el => {
          if (!el) return;
          const handler = () => {
            const pageId = el.getAttribute('data-page');
            if (pageId === 'mapa') abrirMapa();
            else window.showPage(pageId);
          };
          el.addEventListener('click', handler);
          el.addEventListener('touchstart', handler);
        });

        // Inicializar selects al inicio
        document.querySelectorAll('select').forEach(el => M.FormSelect.init(el));
        // P谩gina inicial
        window.showPage('panel');
      }); //  cierre 煤nico del document.addEventListener

  

    function generarTablaVistaPrevia(data) {
      const container = document.getElementById('tablaResultadosInforme');
      const btnDescarga = document.getElementById('btnDescargarInforme');
      const countDescarga = document.getElementById('countDescarga');
      container.innerHTML = '';

      if (!data || !Array.isArray(data) || data.length === 0) {
        if (!Array.isArray(data)) {
          container.innerHTML = '<p class="center-align red-text">Error: Datos inv谩lidos recibidos.</p>';
        } else {
          container.innerHTML = '<p class="center-align">No se encontraron resultados con los filtros aplicados.</p>';
        }
        btnDescarga.disabled = true;
        countDescarga.textContent = 0;
        return;
      }

      countDescarga.textContent = data.length;
      btnDescarga.disabled = false;

      let html = '';

      data.slice(0, 400).forEach(r => {
        const classEstado = getClassForStatus(r.estado);
        const classEnergia = getClassForStatus(r.energia);
        const classConectividad = getClassForStatus(r.conectividad);

        html += `
        <div class="resultado-item">
          <p><strong>ID:</strong> ${r.id}</p>
          <p><strong>Direcci贸n:</strong> ${r.direccion}</p>
          <p><strong>Estado:</strong> <span class="${classEstado}">${r.estado}</span></p>
          <p><strong>Energ铆a:</strong> <span class="${classEnergia}">${r.energia}</span></p>
          <p><strong>Conectividad:</strong> <span class="${classConectividad}">${r.conectividad}</span></p>
          <p><strong>Proveedor:</strong> ${r.proveedor}</p>
        </div>
      `;
      });

      if (data.length > 400) {
        html += `<p class="center-align" style="font-style: italic; margin-top: 15px;">
        Mostrando las primeras filas. El PDF incluir谩 las ${data.length} filas.
      </p>`;
      }

      container.innerHTML = html;
    }
    function getClassForStatus(status) {
      status = status ? status.toUpperCase() : '';
      switch (status) {
        case 'PEDIDO': return 'amber lighten-4';
        case 'INSTALADO': return 'red lighten-4';
        case 'CONECTADA': return 'green lighten-4';
        case 'PENDIENTE': return 'deep-orange lighten-4';
        default: return '';
      }
    }

  </script>
</body>

</html>